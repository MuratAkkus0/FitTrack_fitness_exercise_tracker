{% extends 'user_dashboard/dashboard_template.html.twig' %}

{% block dashboard_content %}

	<div
		class="space-y-6" data-controller="exercise-detail" data-exercise-detail-exercise-id-value="{{ exercise.id }}" data-exercise-detail-programs-api-url-value="{{ path('app_programs_api') }}" data-exercise-detail-add-to-program-url-value="{{ path('app_programs_add_exercise', {'programId': '__PROGRAM_ID__', 'exerciseId': '__EXERCISE_ID__'}) }}" data-exercise-detail-toggle-favorite-url-value="{{ path('app_exercises_toggle_favorite', {'id': exercise.id}) }}">
		<!-- Back Button -->
		<div class="flex items-center space-x-4">
			<a href="{{ path('app_exercises_index') }}" class="flex items-center text-indigo-600 hover:text-indigo-800 transition">
				<i class="fas fa-arrow-left mr-2"></i>
				Back to Exercise Library
			</a>
		</div>

		<!-- Exercise Details -->
		<div class="bg-white rounded-xl shadow-md p-6">
			<div class="flex justify-between items-start mb-6">
				<div>
					<h1 class="text-2xl font-bold text-indigo-900 mb-2">{{ exercise.name }}</h1>
					<span class="inline-block bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full text-sm font-medium">
						{{ exercise.targetMuscleGroup ? exercise.targetMuscleGroup.getLabel() : 'Unknown' }}
					</span>
				</div>
				<div class="flex space-x-3">
					<button data-exercise-detail-target="addToProgramBtn" data-action="click->exercise-detail#openAddToProgramModal" class="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2 rounded-lg font-medium transition flex items-center">
						<i class="fas fa-plus mr-2"></i>
						Add to Program
					</button>
					<button data-exercise-detail-target="favoriteBtn" data-action="click->exercise-detail#toggleFavorite" class="{{ isFavorite ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-100 text-gray-700 hover:bg-gray-200' }} px-4 py-2 rounded-lg font-medium transition flex items-center">
						<i class="fas fa-heart mr-2"></i>
						Favorite
					</button>
				</div>
			</div>

			<!-- Exercise Media -->
			{% if exercise.imageUrl or exercise.videoUrl %}
				<div class="mb-6">
					<div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
						{% if exercise.imageUrl %}
							<div>
								<h3 class="text-lg font-semibold text-gray-800 mb-3">Exercise Image</h3>
								<div class="rounded-lg overflow-hidden bg-gray-100">
									<img src="{{ exercise.imageUrl }}" alt="{{ exercise.name }}" class="w-full h-64 object-cover" onerror="this.parentElement.innerHTML='<div class=\'flex items-center justify-center h-64 text-gray-400\'>Image not available</div>'">
								</div>
							</div>
						{% endif %}
						{% if exercise.videoUrl %}
							<div>
								<h3 class="text-lg font-semibold text-gray-800 mb-3">Exercise Video</h3>
								<div class="rounded-lg overflow-hidden bg-gray-100">
									{% if 'youtube.com' in exercise.videoUrl or 'youtu.be' in exercise.videoUrl %}
										{% set videoId = exercise.videoUrl|replace({'https://www.youtube.com/watch?v=': '', 'https://youtu.be/': '', '&': '?'})|split('?')[0] %}
										<iframe width="100%" height="256" src="https://www.youtube.com/embed/{{ videoId }}" frameborder="0" allowfullscreen class="rounded-lg"></iframe>
									{% else %}
										<a href="{{ exercise.videoUrl }}" target="_blank" class="flex items-center justify-center h-64 bg-red-50 text-red-600 hover:bg-red-100 transition">
											<i class="fas fa-play-circle text-4xl mr-3"></i>
											<span class="text-lg font-medium">Watch Video</span>
										</a>
									{% endif %}
								</div>
							</div>
						{% endif %}
					</div>
				</div>
			{% endif %}

			<!-- Description -->
			<div class="mb-6">
				<h3 class="text-lg font-semibold text-gray-800 mb-3">Description</h3>
				<p class="text-gray-600 leading-relaxed">{{ exercise.description }}</p>
			</div>

			<!-- Exercise Instructions -->
			<div class="mb-6">
				<h3 class="text-lg font-semibold text-gray-800 mb-3">How to Perform</h3>
				<div class="bg-gray-50 rounded-lg p-4">
					{% if exercise.instructions %}
						<div class="text-gray-600 leading-relaxed whitespace-pre-line">{{ exercise.instructions }}</div>
					{% else %}
						<p class="text-gray-600 italic">Detailed instructions will be added in future updates.</p>
					{% endif %}
				</div>
			</div>
		</div>

		<!-- Recent Performance -->
		{% if recentPerformance is defined and recentPerformance|length > 0 %}
			<div class="bg-white rounded-xl shadow-md p-6">
				<h3 class="text-lg font-semibold text-gray-800 mb-4">Your Recent Performance</h3>
				<div class="overflow-x-auto">
					<table class="min-w-full divide-y divide-gray-200">
						<thead class="bg-gray-50">
							<tr>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sets</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reps</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Weight (kg)</th>
								<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Volume</th>
							</tr>
						</thead>
						<tbody class="bg-white divide-y divide-gray-200">
							{% for performance in recentPerformance %}
								<tr>
									<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
										{{ performance.created_at.format('d.m.Y') }}
									</td>
									<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
										{{ performance.sets }}
									</td>
									<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
										{{ performance.reps }}
									</td>
									<td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
										{{ performance.weight }}
									</td>
									<td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">
										{{ (performance.weight * performance.reps * performance.sets)|number_format(1) }}
									</td>
								</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>
			</div>
		{% endif %}

		<!-- Similar Exercises -->
		{% if similarExercises is defined and similarExercises|length > 0 %}
			<div class="bg-white rounded-xl shadow-md p-6">
				<h3 class="text-lg font-semibold text-gray-800 mb-4">Similar Exercises</h3>
				<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
					{% for similarExercise in similarExercises %}
						<a href="{{ path('app_exercises_show', {'id': similarExercise.id}) }}" class="block border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer">
							<h4 class="font-semibold text-gray-800 mb-2">{{ similarExercise.name }}</h4>
							<p class="text-gray-600 text-sm mb-3 line-clamp-2">{{ similarExercise.description }}</p>
							<span class="inline-block bg-indigo-100 text-indigo-800 px-2 py-1 rounded-full text-xs">
								{{ similarExercise.targetMuscleGroup ? similarExercise.targetMuscleGroup.getLabel() : 'Unknown' }}
							</span>
						</a>
					{% endfor %}
				</div>
			</div>
		{% endif %}
	</div>

	<!-- Add to Program Modal -->
	<div data-exercise-detail-target="addToProgramModal" data-action="click->exercise-detail#modalBackdropClick" class="fixed inset-0 hidden overflow-y-auto h-full w-full z-50">
		<div class="fixed inset-0 bg-[rgba(0,0,0,0.5)] transition-all duration-300"></div>
		<div data-exercise-detail-target="addToProgramModalContent" class="relative top-10 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white transform transition-all duration-300 scale-95 opacity-0">
			<div class="mt-3">
				<div class="flex justify-between items-center mb-4">
					<h3 class="text-lg font-bold text-indigo-900">Add to Program</h3>
					<button data-exercise-detail-target="closeAddToProgramModalBtn" data-action="click->exercise-detail#closeAddToProgramModal" class="text-gray-400 hover:text-gray-600 transition-colors duration-200">
						<i class="fas fa-times"></i>
					</button>
				</div>

				<div class="space-y-4">
					<div>
						<label class="block text-sm font-medium text-gray-700 mb-2">Select Program</label>
						<div data-exercise-detail-target="programsList" class="space-y-2 max-h-60 overflow-y-auto">
							<div class="text-center text-gray-500 py-4">Loading programs...</div>
						</div>
					</div>

					<div class="flex justify-end space-x-3 pt-4 border-t border-gray-200">
						<button type="button" data-exercise-detail-target="cancelAddToProgramBtn" data-action="click->exercise-detail#closeAddToProgramModal" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200 transition-colors duration-200">
							Cancel
						</button>
						<button type="button" data-exercise-detail-target="confirmAddToProgramBtn" data-action="click->exercise-detail#addToProgram" class="px-4 py-2 bg-orange-500 text-white rounded-md hover:bg-orange-600 transition-colors duration-200" disabled>
							Add to Program
						</button>
					</div>
				</div>
			</div>
		</div>
	</div>

	<style>
		[data-exercise-detail-target="addToProgramModal"].active {
			display: block !important;
		}

		[data-exercise-detail-target="addToProgramModal"].active [data-exercise-detail-target="addToProgramModalContent"] {
			transform: scale(1) !important;
			opacity: 1 !important;
		}

		.line-clamp-2 {
			display: -webkit-box;
			-webkit-line-clamp: 2;
			-webkit-box-orient: vertical;
			overflow: hidden;
		}
	</style>

{% endblock %}
